services:
  web:
    ports: []
    environment:
      APP_ENV: production
      ENFORCE_STRICT_SECURITY: "1"
      FRONTEND_PUBLIC_API_BASE: https://${APP_DOMAIN}/api

  api-gateway:
    ports: []
    environment:
      APP_ENV: production
      ENFORCE_STRICT_SECURITY: "1"
      JWT_SECRET_FILE: /run/secrets/jwt_secret
      INTERNAL_SERVICE_SECRET_FILE: /run/secrets/internal_service_secret
      CORS_ALLOWED_ORIGINS: https://${APP_DOMAIN}
      REFRESH_COOKIE_SECURE: "1"
      REFRESH_COOKIE_SAMESITE: lax
      REFRESH_COOKIE_DOMAIN: ${APP_DOMAIN}
      REFRESH_COOKIE_NAME: refresh_token
    secrets:
      - jwt_secret
      - internal_service_secret

  auth-service:
    ports: []
    environment:
      APP_ENV: production
      ENFORCE_STRICT_SECURITY: "1"
      JWT_SECRET_FILE: /run/secrets/jwt_secret
      INTERNAL_SERVICE_SECRET_FILE: /run/secrets/internal_service_secret
      DATABASE_URL_FILE: /run/secrets/database_url
      EMAIL_VERIFY_REQUIRED: "1"
      EXPOSE_VERIFICATION_TOKEN: "0"
      ADMIN_BOOTSTRAP_EMAIL: ${ADMIN_BOOTSTRAP_EMAIL}
    secrets:
      - jwt_secret
      - internal_service_secret
      - database_url

  catalog-service:
    ports: []
    environment:
      APP_ENV: production
      ENFORCE_STRICT_SECURITY: "1"
      JWT_SECRET_FILE: /run/secrets/jwt_secret
      INTERNAL_SERVICE_SECRET_FILE: /run/secrets/internal_service_secret
      DATABASE_URL_FILE: /run/secrets/database_url
    secrets:
      - jwt_secret
      - internal_service_secret
      - database_url

  search-service:
    ports: []
    environment:
      APP_ENV: production
      ENFORCE_STRICT_SECURITY: "1"
      INTERNAL_SERVICE_SECRET_FILE: /run/secrets/internal_service_secret
    secrets:
      - internal_service_secret

  download-service:
    ports: []
    environment:
      APP_ENV: production
      ENFORCE_STRICT_SECURITY: "1"
      JWT_SECRET_FILE: /run/secrets/jwt_secret
      INTERNAL_SERVICE_SECRET_FILE: /run/secrets/internal_service_secret
      DATABASE_URL_FILE: /run/secrets/database_url
    secrets:
      - jwt_secret
      - internal_service_secret
      - database_url

  stream-service:
    ports: []
    environment:
      APP_ENV: production
      ENFORCE_STRICT_SECURITY: "1"
      JWT_SECRET_FILE: /run/secrets/jwt_secret
      INTERNAL_SERVICE_SECRET_FILE: /run/secrets/internal_service_secret
      DATABASE_URL_FILE: /run/secrets/database_url
      PUBLIC_STREAM_BASE: https://${APP_DOMAIN}/api
    secrets:
      - jwt_secret
      - internal_service_secret
      - database_url

  admin-service:
    ports: []
    environment:
      APP_ENV: production
      ENFORCE_STRICT_SECURITY: "1"
      JWT_SECRET_FILE: /run/secrets/jwt_secret
      INTERNAL_SERVICE_SECRET_FILE: /run/secrets/internal_service_secret
      DATABASE_URL_FILE: /run/secrets/database_url
    secrets:
      - jwt_secret
      - internal_service_secret
      - database_url

  download-worker:
    environment:
      APP_ENV: production
      ENFORCE_STRICT_SECURITY: "1"
      JWT_SECRET_FILE: /run/secrets/jwt_secret
      INTERNAL_SERVICE_SECRET_FILE: /run/secrets/internal_service_secret
      DATABASE_URL_FILE: /run/secrets/database_url
    secrets:
      - jwt_secret
      - internal_service_secret
      - database_url

  db-migrate:
    environment:
      APP_ENV: production
      ENFORCE_STRICT_SECURITY: "1"
      DATABASE_URL_FILE: /run/secrets/database_url
    secrets:
      - database_url

  edge:
    image: nginx:1.27-alpine
    depends_on:
      web:
        condition: service_started
      api-gateway:
        condition: service_started
      stream-service:
        condition: service_started
    environment:
      APP_DOMAIN: ${APP_DOMAIN}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infra/nginx/default.conf.template:/etc/nginx/templates/default.conf.template:ro
    secrets:
      - tls_cert
      - tls_key

secrets:
  jwt_secret:
    file: ./infra/secrets/jwt_secret.txt
  internal_service_secret:
    file: ./infra/secrets/internal_service_secret.txt
  database_url:
    file: ./infra/secrets/database_url.txt
  tls_cert:
    file: ./infra/secrets/tls.crt
  tls_key:
    file: ./infra/secrets/tls.key
